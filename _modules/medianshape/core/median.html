

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>medianshape.core.median &mdash; MedianShape 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="MedianShape 1.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> MedianShape
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html"><strong>Getting started</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core/lp.html"><strong>Linear Programs</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiments/experiments.html"><strong>Experiments</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simplicial/simplicial-settings.html"><strong>Simplicial Settings</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viz/viz.html"><strong>Visualization</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html"><strong>Utils</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">MedianShape: Simplicial Median Shape</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">MedianShape</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>medianshape.core.median</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for medianshape.core.median</h1><div class="highlight"><pre>
<span></span><span class="c1">#encoding: utf-8</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Mass Regularized Simplicial Median Shape(MRSMS)</span>
<span class="sd">===============================================</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>

<span class="kn">from</span> <span class="nn">medianshape</span> <span class="kn">import</span> <span class="n">utils</span> 
<span class="kn">import</span> <span class="nn">medianshape.experiment.inout</span> <span class="kn">as</span> <span class="nn">inout</span>
<span class="kn">from</span> <span class="nn">medianshape.core.lp_solver</span> <span class="kn">import</span> <span class="n">lp_solver</span>

<div class="viewcode-block" id="median"><a class="viewcode-back" href="../../../core/median.html#medianshape.core.median.median">[docs]</a><span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">simplices</span><span class="p">,</span> <span class="n">subsimplices</span><span class="p">,</span> <span class="n">input_currents</span><span class="p">,</span> <span class="n">lambda_</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[],</span> <span class="n">v</span><span class="o">=</span><span class="p">[],</span> <span class="n">cons</span><span class="o">=</span><span class="p">[],</span> <span class="n">alphas</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Accepts simplicial settings, input currents, multiscale factor(:math:`\lambda`) </span>
<span class="sd">    and mass regularizing factor(:math:`\mu`). </span>
<span class="sd">    Returns median shape and flat norm decomposition in the given</span>
<span class="sd">    simplicial settings. Let K be an underlying simplicial complex of dimension q.</span>

<span class="sd">    :param float points: points in K.</span>
<span class="sd">    :param int simplices: (p+1)-simplices in K, an array of dimension (nx(p+1)) </span>
<span class="sd">        where :math:`p+1 \leq q` and n is the number of p+1-simplices in K. </span>
<span class="sd">    :param int subsimplices: p-simplices in K, an array of dimension (mxp) </span>
<span class="sd">        where :math:`p \leq q` and m is the number of p-simplice in K. </span>
<span class="sd">    :param int input_currents: input currents, an array of dimension kxm </span>
<span class="sd">        where k is the number of input currents.</span>
<span class="sd">    :param float lambda_: multiscale factor.  </span>
<span class="sd">    :param float mu: Mass regularizing factor (no mass regularization when set to 0).</span>
<span class="sd">    :param float w: a vector of subsimplices volumes.</span>
<span class="sd">    :param float v: a vector of simplices volumes.</span>
<span class="sd">    :param int cons: a constraint matrix A of dimension kmx(2m+k(2m+2n)).</span>
<span class="sd">    :param float alphas: Weights for input currents if none, :math:`\\alpha_{i}=\\frac{1}{k}`.</span>
<span class="sd">    :returns: t, q, r, objective_value -- median current, p-chains, (p+1)-chains for median shape decompostion, minimum value of the objective function.</span>
<span class="sd">    :rtype: int, int, int, float.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_currents</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">input_currents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_currents</span><span class="p">)</span>
    <span class="n">m_subsimplices</span> <span class="o">=</span> <span class="n">subsimplices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_simplices</span> <span class="o">=</span> <span class="n">simplices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k_currents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_currents</span><span class="p">)</span>
    <span class="n">sub_cons_count</span> <span class="o">=</span> <span class="n">k_currents</span> 
    <span class="n">input_currents</span>  <span class="o">=</span> <span class="n">input_currents</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">k_currents</span><span class="o">*</span><span class="n">m_subsimplices</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">simpvol</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">subsimplices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">simpvol</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">simplices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cons</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">cons</span> <span class="o">=</span> <span class="n">get_lp_inputs</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">simplices</span><span class="p">,</span> <span class="n">subsimplices</span><span class="p">,</span> <span class="n">k_currents</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="p">[],</span> <span class="n">cons</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">input_currents</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">mu</span>
    <span class="n">sub_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">lambda_</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">lambda_</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
    <span class="n">sub_c</span> <span class="o">=</span> <span class="n">sub_c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_c</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">k_sub_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sub_c</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_cons_count</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">alphas</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">k_sub_c</span><span class="o">=</span> <span class="n">k_sub_c</span><span class="o">/</span><span class="n">k_currents</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_currents</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k_currents</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">k_sub_c</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n_simplices</span><span class="p">):(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n_simplices</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="n">k_sub_c</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n_simplices</span><span class="p">):(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n_simplices</span><span class="p">)]</span><span class="o">*</span><span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_sub_c</span><span class="p">)</span>

    <span class="n">inout</span><span class="o">.</span><span class="n">dump_lp</span><span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sol_x</span><span class="p">,</span> <span class="n">objective_value</span> <span class="o">=</span> <span class="n">lp_solver</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">sol_x1</span> <span class="o">=</span> <span class="n">sol_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol_x</span> <span class="o">&gt;=</span><span class="mf">1e-5</span><span class="p">)]</span>
    <span class="n">sol_x2</span> <span class="o">=</span> <span class="n">sol_x1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol_x1</span> <span class="o">&lt;=</span> <span class="mf">0.99999</span><span class="p">)]</span>
    <span class="n">nonint</span> <span class="o">=</span> <span class="n">sol_x2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">print</span> <span class="s2">&quot;Dimesion of Medianshape LP: </span><span class="si">%d</span><span class="s2">x</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cons</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">print</span> <span class="s1">&#39;LP objective value:&#39;</span><span class="p">,</span> <span class="n">objective_value</span>
    <span class="k">print</span> <span class="s1">&#39;LP time </span><span class="si">%f</span><span class="s1"> mins.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elapsed</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;The number of non integers in the solution&quot;</span><span class="p">,</span> <span class="n">nonint</span>
    <span class="n">sol_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">sol_x</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">sol_x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m_subsimplices</span><span class="p">]</span> <span class="o">-</span> <span class="n">sol_x</span><span class="p">[</span><span class="n">m_subsimplices</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sub_cons_count</span><span class="p">,</span> <span class="n">m_subsimplices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sub_cons_count</span><span class="p">,</span> <span class="n">n_simplices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">qi_start</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub_cons_count</span><span class="p">):</span>
        <span class="n">qi_end</span> <span class="o">=</span> <span class="n">qi_start</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span>
        <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sol_x</span><span class="p">[</span><span class="n">qi_start</span><span class="p">:</span> <span class="n">qi_start</span><span class="o">+</span><span class="n">m_subsimplices</span><span class="p">]</span> <span class="o">-</span> <span class="n">sol_x</span><span class="p">[</span><span class="n">qi_start</span><span class="o">+</span><span class="n">m_subsimplices</span><span class="p">:</span> <span class="n">qi_end</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m_subsimplices</span><span class="p">,)</span>
        <span class="n">ri_start</span> <span class="o">=</span> <span class="n">qi_end</span>
        <span class="n">ri_end</span> <span class="o">=</span> <span class="n">ri_start</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_simplices</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sol_x</span><span class="p">[</span><span class="n">ri_start</span><span class="p">:</span> <span class="n">ri_start</span><span class="o">+</span><span class="n">n_simplices</span><span class="p">]</span> <span class="o">-</span> <span class="n">sol_x</span><span class="p">[</span><span class="n">ri_start</span><span class="o">+</span><span class="n">n_simplices</span><span class="p">:</span> <span class="n">ri_end</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_simplices</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">qi_start</span> <span class="o">=</span> <span class="n">ri_end</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">objective_value</span></div>

<div class="viewcode-block" id="get_lp_inputs"><a class="viewcode-back" href="../../../core/median.html#medianshape.core.median.get_lp_inputs">[docs]</a><span class="k">def</span> <span class="nf">get_lp_inputs</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">simplices</span><span class="p">,</span> <span class="n">subsimplices</span><span class="p">,</span> <span class="n">k_currents</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[],</span> <span class="n">v</span><span class="o">=</span><span class="p">[],</span> <span class="n">b_matrix</span><span class="o">=</span><span class="p">[],</span> <span class="n">cons</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Accepts simplicial settings along with number of currents and returns inputs of median shape LP</span>
<span class="sd">    such as simplicial volumes, boundary matrix and LP contraint matrix so that we can run multiple experiments in the same LP settings without computational repetition such as computing median shape for diffent values of mass regularization factor lambda.</span>

<span class="sd">    :param float points: points in K.</span>
<span class="sd">    :param int simplices: (p+1)-simplices in K, an array of dimension (nx(p+1)). </span>
<span class="sd">        where :math:`p+1 \leq q` and n is the number of p+1-simplices in K. </span>
<span class="sd">    :param int subsimplices: p-simplices in K, an array of dimension (mxp) </span>
<span class="sd">        where :math:`p \leq q` and m is the number of p-simplice in K. </span>
<span class="sd">    :param int k_currents: number of input currents</span>
<span class="sd">        where k is the number of input currents.</span>
<span class="sd">    :param float w: a vector of subsimplices volumes.</span>
<span class="sd">    :param float v: a vector of simplicial volumes.</span>
<span class="sd">    :param int b_matrix: a boundary matrix representing the boundary operator :math:`\partial_{p+1}` of K.</span>
<span class="sd">    :param int cons: a constraint matrix A of dimension kmx(2m+k(2m+2n)).</span>
<span class="sd">    :returns: t, q, r, objective_value -- median current, p-chains, p+1-chains for median shape decompostion, minimum value of the objective function.</span>
<span class="sd">    :rtype: int, int, int, float.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">m_subsimplices</span> <span class="o">=</span> <span class="n">subsimplices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_simplices</span> <span class="o">=</span> <span class="n">simplices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">simpvol</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">subsimplices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">simpvol</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">simplices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_matrix</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">b_matrix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">boundary_matrix</span><span class="p">(</span><span class="n">simplices</span><span class="p">,</span> <span class="n">subsimplices</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;coo&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cons</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">sub_cons_count</span> <span class="o">=</span> <span class="n">k_currents</span>
        <span class="n">m_subsimplices_identity</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">m_subsimplices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;coo&#39;</span><span class="p">)</span>
        <span class="n">identity_cons</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">m_subsimplices_identity</span><span class="p">,</span> <span class="o">-</span><span class="n">m_subsimplices_identity</span><span class="p">))</span>
        <span class="n">sub_cons</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">m_subsimplices_identity</span><span class="p">,</span> <span class="n">m_subsimplices_identity</span><span class="p">,</span> <span class="o">-</span><span class="n">b_matrix</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">))</span>
        <span class="n">sub_cons_col_count</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">m_subsimplices</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_simplices</span>
        <span class="n">zero_sub_cons</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">m_subsimplices</span><span class="p">,</span> <span class="n">sub_cons_col_count</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub_cons_count</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k_identity_cons</span> <span class="o">=</span> <span class="n">identity_cons</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_identity_cons</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">k_identity_cons</span><span class="p">,</span> <span class="n">identity_cons</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sub_cons_count</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub_cons_count</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cons_row</span> <span class="o">=</span> <span class="n">sub_cons</span>
                <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cons_row</span> <span class="o">=</span> <span class="n">zero_sub_cons</span> 
                <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">cons_row</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cons_row</span><span class="p">,</span> <span class="n">sub_cons</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cons_row</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cons_row</span><span class="p">,</span> <span class="n">zero_sub_cons</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cons</span> <span class="o">=</span> <span class="n">cons_row</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cons</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">cons</span><span class="p">,</span> <span class="n">cons_row</span><span class="p">))</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">k_identity_cons</span><span class="p">,</span> <span class="n">cons</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">cons</span></div>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright GNU GPL.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>